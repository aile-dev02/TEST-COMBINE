<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テスト組み合わせ生成ツール - 包括的テスト</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- カスタムCSS -->
    <link href="styles/main.css" rel="stylesheet">
    
    <style>
        .test-console {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .test-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .test-status.running {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .test-status.success {
            background-color: #d1edff;
            border: 1px solid #74c0fc;
            color: #0c5460;
        }
        
        .test-status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .test-button {
            margin: 5px;
        }
        
        .test-results-summary {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="bg-primary text-white py-3 mb-4">
            <div class="container">
                <h1 class="h3 mb-0">
                    <i class="bi bi-check2-square me-2"></i>
                    テスト組み合わせ生成ツール - 包括的テスト
                </h1>
                <p class="mb-0">単体テスト、統合テスト、ブラウザ互換性テストの実行</p>
            </div>
        </header>
        
        <div class="container">
            <!-- テスト実行コントロール -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-play-circle me-2"></i>
                                テスト実行コントロール
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>個別テスト実行</h6>
                                    <button id="run-unit-tests" class="btn btn-outline-primary test-button">
                                        <i class="bi bi-gear me-1"></i>単体テスト実行
                                    </button>
                                    <button id="run-integration-tests" class="btn btn-outline-success test-button">
                                        <i class="bi bi-link me-1"></i>統合テスト実行
                                    </button>
                                    <button id="run-quick-tests" class="btn btn-outline-info test-button">
                                        <i class="bi bi-lightning me-1"></i>クイックテスト
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <h6>包括的テスト実行</h6>
                                    <button id="run-all-tests" class="btn btn-primary test-button">
                                        <i class="bi bi-play-fill me-1"></i>全テスト実行
                                    </button>
                                    <button id="export-results" class="btn btn-outline-secondary test-button" disabled>
                                        <i class="bi bi-download me-1"></i>結果エクスポート
                                    </button>
                                    <button id="clear-console" class="btn btn-outline-warning test-button">
                                        <i class="bi bi-trash me-1"></i>コンソールクリア
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- テスト実行状況 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div id="test-status" class="test-status" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span id="test-status-text">テスト実行中...</span>
                        </div>
                    </div>
                    
                    <div id="progress-container" class="progress-container" style="display: none;">
                        <div class="progress">
                            <div id="test-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="progress-text" class="text-muted">準備中...</small>
                    </div>
                </div>
            </div>
            
            <!-- テスト結果サマリー -->
            <div class="row mb-4">
                <div class="col-12">
                    <div id="test-results-summary" class="test-results-summary" style="display: none;">
                        <h5>
                            <i class="bi bi-bar-chart me-2"></i>
                            テスト結果サマリー
                        </h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div id="total-tests" class="metric-value">0</div>
                                    <div class="metric-label">総テスト数</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                                    <div id="passed-tests" class="metric-value">0</div>
                                    <div class="metric-label">成功</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card" style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);">
                                    <div id="failed-tests" class="metric-value">0</div>
                                    <div class="metric-label">失敗</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <div id="success-rate" class="metric-value">0%</div>
                                    <div class="metric-label">成功率</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>実行時間</h6>
                                <p id="execution-time" class="mb-0">-</p>
                            </div>
                            <div class="col-md-6">
                                <h6>ブラウザ情報</h6>
                                <p id="browser-info" class="mb-0">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- テストコンソール -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-terminal me-2"></i>
                                テストコンソール
                            </h5>
                            <div>
                                <button id="toggle-auto-scroll" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-arrow-down me-1"></i>自動スクロール: ON
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="test-console" class="test-console">
                                テスト実行ログがここに表示されます...\n\n
                                使用方法:
                                1. 上記のボタンからテストを実行してください
                                2. 「全テスト実行」で包括的なテストを実行できます
                                3. 「クイックテスト」で基本的なテストのみ実行できます
                                4. 結果は自動的にローカルストレージに保存されます
                                
                                ブラウザ情報:
                                - User Agent: ${navigator.userAgent}
                                - Platform: ${navigator.platform}
                                - Language: ${navigator.language}
                                - Viewport: ${window.innerWidth}x${window.innerHeight}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 要件カバレッジ -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-check-circle me-2"></i>
                                要件カバレッジ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="requirements-coverage">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>実装済み要件</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i>Requirement 1.2: ブラウザ互換性テスト</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i>Requirement 1.3: レスポンシブデザインテスト</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i>Requirement 2.2: データバリデーションテスト</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i>Requirement 3.2: アルゴリズム正確性テスト</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i>Requirement 4.2: 3因子間網羅テスト</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>テストカテゴリ</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="bi bi-gear-fill text-primary me-2"></i>単体テスト (Unit Tests)</li>
                                            <li><i class="bi bi-link-45deg text-info me-2"></i>統合テスト (Integration Tests)</li>
                                            <li><i class="bi bi-browser-chrome text-warning me-2"></i>ブラウザ互換性テスト</li>
                                            <li><i class="bi bi-phone text-success me-2"></i>レスポンシブデザインテスト</li>
                                            <li><i class="bi bi-speedometer2 text-danger me-2"></i>パフォーマンステスト</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap 5 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- アプリケーションスクリプト -->
    <script src="js/main.js"></script>
    <script src="js/tests.js"></script>
    <script src="js/unit-tests.js"></script>
    <script src="js/integration-tests.js"></script>
    <script src="js/test-runner.js"></script>
    
    <script>
        // テストページの初期化とイベントハンドラ
        document.addEventListener('DOMContentLoaded', function() {
            const testConsole = document.getElementById('test-console');
            const testStatus = document.getElementById('test-status');
            const testStatusText = document.getElementById('test-status-text');
            const progressContainer = document.getElementById('progress-container');
            const testProgress = document.getElementById('test-progress');
            const progressText = document.getElementById('progress-text');
            const testResultsSummary = document.getElementById('test-results-summary');
            const exportButton = document.getElementById('export-results');
            
            let autoScroll = true;
            let currentTestResults = null;
            
            // コンソール出力のオーバーライド
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            
            function appendToConsole(message, type = 'log') {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const prefix = type === 'error' ? '❌' : type === 'warn' ? '⚠️' : 'ℹ️';
                const formattedMessage = `[${timestamp}] ${prefix} ${message}`;
                
                testConsole.textContent += formattedMessage + '\n';
                
                if (autoScroll) {
                    testConsole.scrollTop = testConsole.scrollHeight;
                }
            }
            
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                appendToConsole(args.join(' '), 'log');
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                appendToConsole(args.join(' '), 'error');
            };
            
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                appendToConsole(args.join(' '), 'warn');
            };
            
            // テスト実行状況の表示
            function showTestStatus(message, isRunning = true) {
                testStatusText.textContent = message;
                testStatus.className = `test-status ${isRunning ? 'running' : 'success'}`;
                testStatus.style.display = 'block';
                
                if (isRunning) {
                    progressContainer.style.display = 'block';
                    testProgress.style.width = '0%';
                    progressText.textContent = '準備中...';
                }
            }
            
            function hideTestStatus() {
                testStatus.style.display = 'none';
                progressContainer.style.display = 'none';
            }
            
            function updateProgress(percentage, message) {
                testProgress.style.width = `${percentage}%`;
                progressText.textContent = message;
            }
            
            // テスト結果サマリーの更新
            function updateTestSummary(results) {
                if (!results || !results.overall) return;
                
                document.getElementById('total-tests').textContent = results.overall.totalTests || 0;
                document.getElementById('passed-tests').textContent = results.overall.passedTests || 0;
                document.getElementById('failed-tests').textContent = results.overall.failedTests || 0;
                document.getElementById('success-rate').textContent = 
                    (results.overall.successRate || 0).toFixed(1) + '%';
                
                const executionTime = results.overall.executionTime || 0;
                document.getElementById('execution-time').textContent = 
                    `${(executionTime / 1000).toFixed(2)}秒`;
                
                const browserInfo = results.integration?.browserInfo;
                if (browserInfo) {
                    document.getElementById('browser-info').textContent = 
                        `${browserInfo.browser} (${browserInfo.platform})`;
                }
                
                testResultsSummary.style.display = 'block';
                exportButton.disabled = false;
            }
            
            // テスト実行関数
            async function runTests(testType) {
                try {
                    showTestStatus(`${testType}実行中...`);
                    updateProgress(10, 'テスト初期化中...');
                    
                    let results;
                    switch (testType) {
                        case '単体テスト':
                            updateProgress(30, '単体テスト実行中...');
                            results = await runSpecificTests(['unit']);
                            break;
                        case '統合テスト':
                            updateProgress(30, '統合テスト実行中...');
                            results = await runSpecificTests(['integration']);
                            break;
                        case 'クイックテスト':
                            updateProgress(30, 'クイックテスト実行中...');
                            results = await runQuickTests();
                            break;
                        case '全テスト':
                            updateProgress(20, '単体テスト実行中...');
                            await new Promise(resolve => setTimeout(resolve, 500));
                            updateProgress(60, '統合テスト実行中...');
                            await new Promise(resolve => setTimeout(resolve, 500));
                            updateProgress(90, '結果集計中...');
                            results = await runAllTests();
                            break;
                    }
                    
                    updateProgress(100, 'テスト完了');
                    currentTestResults = results;
                    updateTestSummary(results);
                    
                    setTimeout(() => {
                        hideTestStatus();
                        testStatus.className = 'test-status success';
                        testStatusText.textContent = `${testType}が正常に完了しました`;
                        testStatus.style.display = 'block';
                        setTimeout(() => hideTestStatus(), 3000);
                    }, 1000);
                    
                } catch (error) {
                    console.error(`${testType}実行エラー:`, error);
                    hideTestStatus();
                    testStatus.className = 'test-status error';
                    testStatusText.textContent = `${testType}でエラーが発生しました: ${error.message}`;
                    testStatus.style.display = 'block';
                }
            }
            
            // イベントリスナーの設定
            document.getElementById('run-unit-tests').addEventListener('click', () => {
                runTests('単体テスト');
            });
            
            document.getElementById('run-integration-tests').addEventListener('click', () => {
                runTests('統合テスト');
            });
            
            document.getElementById('run-quick-tests').addEventListener('click', () => {
                runTests('クイックテスト');
            });
            
            document.getElementById('run-all-tests').addEventListener('click', () => {
                runTests('全テスト');
            });
            
            document.getElementById('export-results').addEventListener('click', () => {
                if (currentTestResults && testRunner) {
                    try {
                        testRunner.exportResults('json');
                        console.log('テスト結果をJSONファイルとしてエクスポートしました');
                    } catch (error) {
                        console.error('エクスポートエラー:', error);
                    }
                }
            });
            
            document.getElementById('clear-console').addEventListener('click', () => {
                testConsole.textContent = 'コンソールがクリアされました。\n\n';
            });
            
            document.getElementById('toggle-auto-scroll').addEventListener('click', function() {
                autoScroll = !autoScroll;
                this.innerHTML = `<i class="bi bi-arrow-down me-1"></i>自動スクロール: ${autoScroll ? 'ON' : 'OFF'}`;
                this.className = `btn btn-sm ${autoScroll ? 'btn-outline-secondary' : 'btn-outline-warning'}`;
            });
            
            // 初期化完了メッセージ
            console.log('テストページが初期化されました。テストを実行してください。');
            
            // 保存されたテスト結果の読み込み
            if (testRunner) {
                const savedResults = testRunner.loadSavedResults();
                if (savedResults) {
                    console.log('前回のテスト結果が読み込まれました。');
                }
            }
        });
    </script>
</body>
</html>